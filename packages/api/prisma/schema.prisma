generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model TaskTemplate {
  id        String   @id @default(uuid())
  title     String
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Behavior on miss: FAIL_ON_MISS or CARRY_OVER_STACK
  carryPolicy String @default("CARRY_OVER_STACK")

  // Schedule configuration
  // ONCE, DAILY, WEEKLY, MONTHLY, YEARLY, INTERVAL
  scheduleType  String
  startDate     DateTime?    // Ab wann die Aufgabe gilt (default: Erstelldatum)
  anchorDate    DateTime?    // For INTERVAL and week A/B patterns
  // DAY, WEEK, MONTH, YEAR
  intervalUnit  String?
  intervalValue Int?

  // Weekly: days of week (0=Sunday, 1=Monday, etc.)
  weeklyDays String? // Stored as comma-separated: "1,3,5" for Mon,Wed,Fri

  // Monthly
  monthlyDay  Int?        // 1-31, null means use monthlyMode
  // FIRST_DAY, LAST_DAY, SPECIFIC_DAY
  monthlyMode String?

  // Yearly
  yearlyMonth Int? // 1-12
  yearlyDay   Int? // 1-31

  // Optional time (HH:mm format)
  dueTime String?

  // Tags (comma-separated)
  tags String?

  // Sort order for UI
  sortOrder Int @default(0)

  // Relations
  instances TaskInstance[]

  @@index([isActive])
  @@index([scheduleType])
}

model TaskInstance {
  id          String   @id @default(uuid())
  templateId  String
  date        DateTime // Due date (stored as date only, time at 00:00)
  // OPEN, DONE, FAILED
  status      String   @default("OPEN")
  completedAt DateTime?
  createdAt   DateTime @default(now())

  // Relation
  template TaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, date])
  @@index([date])
  @@index([status])
  @@index([templateId])
}

model AppSettings {
  id       String @id @default("app")
  password String // Hashed password
}
